
## 网络优化的核心

1. 速度 网络正常时更好的利用带宽
2. 弱网络 网络不稳定时的连通性
3. 安全 防止第三方劫持、窃听篡改

## 网络连接请求过程

1. DNS解析  解析耗时、localDNS劫持、DNS调度
2. 创建连接  TCP三次握手、TLS秘钥协商、IP/端口选择、是否https
3. 发送/接受数据 利用好带宽、侦测网络延时、弱网下调整包大小
4. 关闭连接  关注主动关闭和被动关闭

### 网络库
1. 统一编程接口
2. 全局网络控制
3. 高性能

## 高质量网络库
### OkHttp、Cronet、Mars

1. HTTPDNS 
	localDNS问题：解析慢、稳定性差易被劫持、准确性差跨地区跨运营商、及时性差（修改TTL导致DNS修改生效延迟）
	HTTPDNS解决上述问题，同时增加**流量调度、网络拨测、网络容灾**等功能。
	
	**流量调度**：DNS流量调度是通过DNS服务器将用户请求分散到多个服务器上，以实现负载均衡。这种方式可以有效地减轻单个服务器的负载，提高整体性能。此外，DNS流量调度还可以根据用户的地理位置和网络拓扑，选择最近的服务器进行访问，从而减少数据传输距离和延迟。这种基于地理位置和运营商的流量负载策略，可以避免用户跨网访问的问题。
	
	**网络拨测**：网络拨测是一种网络性能测试技术，可以帮助企业了解网络的数据传输速度、连接质量等参数。通过进行拨测，可以快速地发现网络问题，并对其进行修复和处理，保证网络的正常运行。此外，网络拨测还可以帮助企业了解用户在使用过程中的真实体验，从而优化网络和应用程序的性能，提升用户的满意度和忠诚度。
	
	**网络容灾**：网络容灾是一种保障网络稳定性和服务质量的策略。当服务器出现故障时，DNS服务器可以自动切换到其他可用服务器，保证解析的稳定性。这种自动切换的机制可以保证在服务器出现故障时，用户能够快速切换到其他可用服务器，从而保证服务的可用性。
	
2. 连接复用
	通过http协议的keep-alive或者http/2.0的多路复用。提升连接复用率，减少连接的耗时。
	
3. 压缩与加密
	**压缩**
	请求URL、请求header、请求body
	请求URL带有的公共参数，可以只上传一次，之后在接收端的接入层进行参数扩展。
	请求body根据选择的通信协议JSON和Protocol Buffers有不同的压缩率，压缩算法也会影响效率，通用的gzip、Google的Brotli或Facebook的Z-standard压缩率更高，图片格式webp、hevc、SharpP，基于AI的图片超清化。
	
	**安全**
	 HTTPS--TLS协议带来的代价：2-RTT的协商成本，弱网下时延过高；后台解密成本高，大型公司需单独集群处理。
	 **提高连接复用率**。多个域名共用一个HTTP/2连接、长连接。
	 **减少握手次数**。TLS 1.3实现0-RTT协商，微信mmtls、FaceBook的fizz、阿里的SlightSSL。
	 **性能提升**。使用ecc代替RSA。Session Ticket会话复用，节省RTT耗时。

## 移动端监控

1. 如何监控网络
	第一种方法：插桩
		系统网络库可以利用Aspect的切面功能，OkHttp还可以利用本身的代理机制简化。
	第二种方法：Native Hook
		连接相关：connect。
		发送数据相关：send 和 sendto。
		接收数据相关：recv 和 recvfrom。
	第三种方法：统一网络库
		时延监控、维度监控、错误监控、流量监控
2. 如何监控流量
	通过trafficStats类 获取整个手机or某个UID
	开机开始Mobile网络接收字节总数；
	开机开始所有网络接收字节总数；
	开机开始Mobile网络发送字节总数；
	开机开始所有网络发送字节总数；