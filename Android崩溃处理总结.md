---
UID: 20240502071821
created: 2024-05-02
---

## ✍崩溃优化
### 一、native代码崩溃捕获流程
编译端。编译 C/C++ 代码时，需要将带符号信息的文件保留下来。
客户端。捕获到崩溃时候，将收集到尽可能多的有用信息写入日志文件，然后选择合适
的时机上传到服务器。
服务端。读取客户端上报的日志文件，寻找适合的符号文件，生成可读的 C/C++ 调用
栈。
### 二、native崩溃捕获难点
#### 1 文件句柄泄露，创建不了日志文件
提前注册文件描述符，需要时候直接使用
#### 2 栈溢出导致文件创建失败
通过sighandler申请备用栈，sigaction注册处理函数来处理
#### 3 堆内存耗尽，无法分配内存
通过重新封装linux syscall support
#### 4 堆破坏或者二次崩溃
fork子进程去处理

### 三、anr处理
#### 1 通过监听/data/anr/traces.txt
#### 2 通过监控消息队列运行时间

### 四、崩溃信息收集
#### 1，手机崩溃现场信息
进程名、线程名、崩溃堆栈、崩溃类型
#### 2，系统信息
log、厂商、型号、系统、cpu、abi、linux版本
####  3，内存信息
系统剩余内存、应用使用内存、虚拟内存
#### 4，资源信息
文件句柄、线程数、JNI
#### 5，应用信息
崩溃场景、操作路径、自定义信息（根据App侧重点定义）、其他（网络、电量、磁盘等等）

### 五、崩溃分析
#### 1，确定重点
##### ①  确认严重程度
考虑是否需要修复？是否紧急
##### ②  崩溃基本信息
java崩溃  根据异常情况，到日志中查看内存信息和资源信息
native崩溃 观察signal、code、fault addr等。了解各种信号基本含义
anr 查看主线程堆栈是否有锁，其次查看IO情况、cpu竞争、GC等
##### ③ 查看Logcat
分析日志文件，是否有关键信息 am_kill am_anr
##### ④ 各个资源情况
内存信息、资源信息等等
#### 2，查找共性
根据机型、ROM、厂商、系统、ABI等等缩小共性范围
#### 3，尝试复现
通过操作路径尝试重现

### 六、系统崩溃处理
1，查找可能原因
2，尝试规避
3，hook解决
